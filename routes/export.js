var exec = require('child_process').exec;
var htmlMinifier = require('html-minifier');

module.exports = function(app, jiraJson2Csv) {
    app.post('/export/csv', function(req, res) {
        // jiraJson is escaped because of it contain single quoute and double quote.
        var jiraJsonString = unescape(req.body.jiraJson);
        console.log("[DEBUG : export.js] jiraJsonString = " + jiraJsonString);
        var jiraJson = JSON.parse(jiraJsonString);     
        res.setHeader('Content-Type', 'text/plain');
        res.end(jiraJson2Csv.toCsv(jiraJson));
    });
    
    app.post('/export/pdf', function(req, res){
        var jiraJsonString = unescape(req.body.jiraJson);
        var jiraJson = JSON.parse(jiraJsonString);
        res.render('export_pdf', {
            'jiraJson':jiraJson,
        }, function(err, html) {
//            var htmlContent = htmlMinifier.minify(html);
//            var htmlContent = html.replace(/(\r\n|\n|\r)/gm, "");
            var htmlContent = html.replace(new RegExp("\n", "g"), "");
            htmlContent = htmlContent.replace(new RegExp("\'", "g"), "\\'");
            htmlContent = htmlContent.replace(new RegExp("\"", "g"), '\\"');
//            htmlContent = '<!DOCTYPE html><html><head><title>Export PDF</title></head><body><div><table><thead><tr style=\'font-weight: bolder;\'><td style=\'width: 800px;\'> Story / Task </td><td style=\'width: 200px;\'> Timespent (hr) </td></tr></thead><tbody><tr style=\'background-color: #5cb85c;\'><td> [BT-1897] Hanuman - Statistics Service </td><td> 12 </td></tr><tr><td> [BT-1934] Create a new Statistics web service endpoint for Janus to call </td><td> 12 </td></tr><tr><td> [BT-1935] Implement the new service in Janus </td><td> 0 </td></tr><tr style=\'background-color: #5cb85c;\'><td> [BT-1902] Hanuman - Detailed logging of Infosoft PUSH requests </td><td> 9 </td></tr><tr><td> [BT-1936] Check the entry point for Infosoft webservice if we have logged in all cases that make changes to Hanuman\'s data states </td><td> 9 </td></tr><tr style=\'background-color: #5cb85c;\'><td> [BT-1903] Hanuman - Detailed logging of Infosoft Robot </td><td> 4 </td></tr><tr><td> [BT-1937] Check in the Hanuman\'s robot(s) if we have logged all cases that make changes to Hanuman\'s data states </td><td> 4 </td></tr><tr style=\'background-color: #5cb85c;\'><td> [BT-1913] Hanuman - Detailed logging of user creation and interactions </td><td> 14 </td></tr><tr><td> [BT-1938] Check all the possibilities that user can be created Eg. Admin, webservice, Infosoft\'s webservice and Robot. All places needed to be logged if they makes any changes to User. </td><td> 14 </td></tr><tr style=\'background-color: #5cb85c;\'><td> [BT-1914] Hanuman - Logging of subscription changes / creation </td><td> 8.5 </td></tr><tr><td> [BT-1939] Check all place that subscription can be updated or changed and log them </td><td> 8.5 </td></tr><tr style=\'background-color: #5cb85c;\'><td> [BT-1933] Hanuman - Create a documentation for logging cases </td><td> 0 </td></tr><tr><td> [BT-1940] Create doc to explain how we log and which case we log </td><td> 0 </td></tr><tr style=\'background-color: #5cb85c;\'><td> Other </td><td> 15 </td></tr><tr><td> [BT-1941] Merge hanuman develop branch to master branch and test </td><td> 15 </td></tr></tbody><tfoot><tr style=\'background-color: #4cae4c;font-weight: bolder;\'><td> Total </td><td> 62.5 </td></tr></tfoot></table></div></body></html>';
//            var htmlContent = '<html><head><title>tet</title></head><body>test</body></html>';
            //htmlContent = '<!DOCTYPE html><html>    <head>        <title>Export PDF</title>    </head>    <body>        <div>            <table>                <thead>                    <tr style="font-weight: bolder;">                        <td style="width: 800px;">                            Story / Task                        </td>                        <td style="width: 200px;">                            Timespent (hr)                        </td>                    </tr>                </thead>                <tbody>                                        <tr style="background-color: #5cb85c;">                        <td>                            [BT-1897] Hanuman - Statistics Service                        </td>                        <td>                            12                        </td>                    </tr>                                                <tr>                            <td>                                [BT-1934] Create a new Statistics web service endpoint for Janus to call                            </td>                            <td>                                12                            </td>                        </tr>                                                <tr>                            <td>                                [BT-1935] Implement the new service in Janus                            </td>                            <td>                                0                            </td>                        </tr>                                                                                    <tr style="background-color: #5cb85c;">                        <td>                            [BT-1902] Hanuman - Detailed logging of Infosoft PUSH requests                        </td>                        <td>                            9                        </td>                    </tr>                                                <tr>                            <td>                                [BT-1936] Check the entry point for Infosoft webservice if we have logged in all cases that make changes to Hanuman\'s data states                            </td>                            <td>                                9                            </td>                        </tr>                                                                                    <tr style="background-color: #5cb85c;">                        <td>                            [BT-1903] Hanuman - Detailed logging of Infosoft Robot                        </td>                        <td>                            4                        </td>                    </tr>                                                <tr>                            <td>                                [BT-1937] Check in the Hanuman\'s robot(s) if we have logged all cases that make changes to Hanuman\'s data states                            </td>                            <td>                                4                            </td>                        </tr>                                                                                    <tr style="background-color: #5cb85c;">                        <td>                            [BT-1913] Hanuman - Detailed logging of user creation and interactions                        </td>                        <td>                            14                        </td>                    </tr>                                                <tr>                            <td>                                [BT-1938] Check all the possibilities that user can be created Eg. Admin, webservice, Infosoft\'s webservice and Robot. All places needed to be logged if they makes any changes to User.                            </td>                            <td>                                14                            </td>                        </tr>                                                                                    <tr style="background-color: #5cb85c;">                        <td>                            [BT-1914] Hanuman - Logging of subscription changes / creation                        </td>                        <td>                            8.5                        </td>                    </tr>                                                <tr>                            <td>                                [BT-1939] Check all place that subscription can be updated or changed and log them                            </td>                            <td>                                8.5                            </td>                        </tr>                                                                                    <tr style="background-color: #5cb85c;">                        <td>                            [BT-1933] Hanuman - Create a documentation for logging cases                        </td>                        <td>                            0                        </td>                    </tr>                                                <tr>                            <td>                                [BT-1940] Create doc to explain how we log and which case we log                            </td>                            <td>                                0                            </td>                        </tr>                                                                                    <tr style="background-color: #5cb85c;">                        <td>                            Other                        </td>                        <td>                            15                        </td>                    </tr>                                                <tr>                            <td>                                [BT-1941] Merge hanuman develop branch to master branch and test                            </td>                            <td>                                15                            </td>                        </tr>                                                                                </tbody>                <tfoot>                    <tr style="background-color: #4cae4c; font-weight: bolder;">                        <td>                            Total                        </td>                        <td>                            62.5                        </td>                    </tr>                </tfoot>            </table>        </div>    </body></html>';
            console.log(htmlContent);
            var child = exec('java -jar exe/html2pdf-1.0.jar "' + htmlContent +  '" "/home/mac/test.pdf"',
            function(error, stdout, stderr) {
                console.log('stdout: ' + stdout);
                console.log('stderr: ' + stderr);
                if (error !== null) {
                    console.log('exec error: ' + error);
                }
            });
        });
    }); 
}
